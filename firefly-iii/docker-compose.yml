version: '3.8'

# Firefly III - Personal Finance Manager
# Deployment: VM 100 (10.0.60.11) - SERVICES VLAN 60
# Replaces: Akaunting (abandoned due to poor Docker support)

networks:
  proxy-internal:
    external: true
  firefly-backend:
    internal: true

volumes:
  firefly-upload:
  firefly-db-data:

services:
  firefly-iii:
    image: fireflyiii/core:latest
    container_name: firefly-iii
    restart: unless-stopped
    depends_on:
      firefly-db:
        condition: service_healthy
    environment:
      # Application
      - APP_ENV=production
      - APP_DEBUG=false
      - SITE_OWNER=${SITE_OWNER}
      - APP_KEY=${APP_KEY}
      - DEFAULT_LANGUAGE=en_US
      - DEFAULT_LOCALE=equal
      - TZ=${TZ:-America/New_York}
      - TRUSTED_PROXIES=**
      - LOG_CHANNEL=stack
      - AUDIT_LOG_LEVEL=emergency
      - APP_LOG_LEVEL=notice

      # Database (PostgreSQL)
      - DB_CONNECTION=pgsql
      - DB_HOST=firefly-db
      - DB_PORT=5432
      - DB_DATABASE=firefly
      - DB_USERNAME=firefly
      - DB_PASSWORD=${DB_PASSWORD}

      # Cache/Session
      - CACHE_DRIVER=file
      - SESSION_DRIVER=file

      # Mail (optional - configure if needed)
      - MAIL_MAILER=log
      - MAIL_HOST=null
      - MAIL_PORT=2525
      - MAIL_FROM=${MAIL_FROM:-noreply@example.com}
      - MAIL_ENCRYPTION=null

      # Authentik handles authentication externally
      # Firefly III receives headers from Traefik forward-auth
    

      # Disable internal 2FA (Authentik provides this)
      - DISABLE_FRAME_HEADER=false
      - DISABLE_CSP_HEADER=false

      # Static cron token for automated recurring transactions
      - STATIC_CRON_TOKEN=${CRON_TOKEN}

    volumes:
      - firefly-upload:/var/www/html/storage/upload
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.firefly.rule=Host(`firefly.local.example.home`)"
      - "traefik.http.routers.firefly.entrypoints=https"
      - "traefik.http.routers.firefly.tls=true"
      - "traefik.http.routers.firefly.tls.certresolver=cloudflare"
      - "traefik.http.routers.firefly.middlewares=authentik@file"
      - "traefik.http.services.firefly.loadbalancer.server.port=8080"
      - "traefik.docker.network=proxy-internal"
    networks:
      - proxy-internal
      - firefly-backend
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  firefly-db:
    image: postgres:15-alpine
    container_name: firefly-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=firefly
      - POSTGRES_USER=firefly
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - firefly-db-data:/var/lib/postgresql/data
    networks:
      - firefly-backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U firefly -d firefly"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Cron job for recurring transactions
  firefly-cron:
    image: alpine:latest
    container_name: firefly-cron
    restart: unless-stopped
    depends_on:
      firefly-iii:
        condition: service_healthy
    command: >
      sh -c "echo '0 3 * * * wget -qO- http://firefly-iii:8080/api/v1/cron/${CRON_TOKEN}' | crontab - && crond -f -L /dev/stdout"
    networks:
      - firefly-backend

  # Optional: Data Importer for CSV/bank imports
  firefly-importer:
    image: fireflyiii/data-importer:latest
    container_name: firefly-importer
    restart: unless-stopped
    profiles:
      - importer
    depends_on:
      firefly-iii:
        condition: service_healthy
    environment:
      - FIREFLY_III_URL=http://firefly-iii:8080
      - VANITY_URL=https://firefly.local.example.home
      - FIREFLY_III_ACCESS_TOKEN=${IMPORTER_ACCESS_TOKEN}
      - TRUSTED_PROXIES=**
      - TZ=${TZ:-America/New_York}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.firefly-importer.rule=Host(`firefly-import.local.example.home`)"
      - "traefik.http.routers.firefly-importer.entrypoints=https"
      - "traefik.http.routers.firefly-importer.tls=true"
      - "traefik.http.routers.firefly-importer.tls.certresolver=cloudflare"
      - "traefik.http.routers.firefly-importer.middlewares=authentik@file"
      - "traefik.http.services.firefly-importer.loadbalancer.server.port=8080"
      - "traefik.docker.network=proxy-internal"
    networks:
      - proxy-internal
      - firefly-backend
